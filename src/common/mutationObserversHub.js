/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
class MutationObserversHub{constructor(t=0){this._delay=t,this._observedNodes=new Map,this._onMutations=this._onMutations.bind(this),this._onTimeout=this._onTimeout.bind(this)}_observe(t,e,s){if(this._observedNodes.has(e))this._observedNodes.get(e).listeners.push({subObserver:t,options:s,throttledMutations:[]});else{const o=new MutationObserver(this._onMutations);this._observedNodes.set(e,{target:e,observer:o,lastInvocationTimeStamp:0,timeoutId:null,listeners:[{subObserver:t,options:s,throttledMutations:[]}]}),o.observe(e,MutationObserversHub.MUTATIONS_OBSERVER_OPTIONS)}}_disconnect(t){for(const[e,s]of Array.from(this._observedNodes.entries()))s.listeners=s.listeners.filter(e=>e.subObserver!==t),0===s.listeners.length&&(s.observer.disconnect(),this._observedNodes.delete(e),null!==s.timeoutId&&(window.clearTimeout(s.timeoutId),s.timeoutId=null))}_takeRecords(t){let e=[];for(const s of Array.from(this._observedNodes.values()))for(const o of s.listeners)o.subObserver===t&&(e=e.concat(o.throttledMutations),o.throttledMutations=[]);return e}_onMutations(t,e){const s=Array.from(this._observedNodes.values()).find(t=>t.observer===e);if(!s)return;const o=Date.now();if(0!==this._delay&&(null!==s.timeoutId||o-s.lastInvocationTimeStamp<this._delay)){let e=!1;for(const o of s.listeners){const r=t.filter(t=>this._isMutationRelevant(t,s.target,o.options));0!==r.length&&(o.throttledMutations=o.throttledMutations.concat(r),e=!0)}e&&null===s.timeoutId&&(s.timeoutId=window.setTimeout(()=>this._onTimeout(s),this._delay))}else{let e=!1;for(const o of s.listeners){const r=t.filter(t=>this._isMutationRelevant(t,s.target,o.options));0!==r.length&&(o.subObserver.callback(r,o.subObserver),e=!0)}e&&(s.lastInvocationTimeStamp=o)}}_isMutationRelevant(t,e,s){if(!s)return!0;if(t.target!==e&&!s.subtree)return!1;switch(t.type){case"attributes":return!!s.attributes&&!(s.attributeFilter&&!s.attributeFilter.includes(t.attributeName));case"characterData":return!!s.characterData;case"childList":return!!s.childList}}_onTimeout(t){for(const e of t.listeners)0!==e.throttledMutations.length&&(e.subObserver.callback(e.throttledMutations,e.subObserver),e.throttledMutations=[]);t.lastInvocationTimeStamp=Date.now(),t.timeoutId=null}createMutationObserver(t){return new MutationObserversHub.MutationSubObserver(this,t)}}MutationObserversHub.MutationSubObserver=class{constructor(t,e){this._hub=t,this.callback=e}observe(t,e={}){this._hub._observe(this,t,e)}disconnect(){this._hub._disconnect(this)}takeRecords(){return this._hub._takeRecords(this)}},MutationObserversHub.MUTATIONS_OBSERVER_OPTIONS={attributes:!0,characterData:!0,childList:!0,subtree:!0},"undefined"!=typeof module&&(module.exports.MutationObserversHub=MutationObserversHub);