/*! (C) Copyright 2020 LanguageTooler GmbH. All rights reserved. */
class Mirror{constructor(e){this._firefoxHackEnabled=!1,this._mimickedElement=e,this._domMeasurement=new DomMeasurement(this._mimickedElement.ownerDocument),this._isRoamResearchIssue=Boolean(location.hostname.match(/roamresearch/)&&e.closest(".roam-article")),this._isHootsuiteIssue=Boolean(location.hostname.match(/hootsuite/)&&e.closest(".rc-TextArea")),this._isDotSyntaxHighlighterIssue=Boolean(e.previousElementSibling&&"wpTextbox0"===e.previousElementSibling.id),this._render=this._render.bind(this),this._updateText=this._updateText.bind(this),this._onMimickedElementScroll=this._onMimickedElementScroll.bind(this),this._onMimickedElementClick=this._onMimickedElementClick.bind(this),this._render(),this._mimickedElement.addEventListener("scroll",this._onMimickedElementScroll),this._mimickedElement.addEventListener("click",this._onMimickedElementClick),this._mimickedElement.addEventListener("input",this._updateText),window.ResizeObserver&&(this._mimickedElementResizeObserver=new window.ResizeObserver(this._render),this._mimickedElementResizeObserver.observe(this._mimickedElement)),this._renderInterval=setAnimationFrameInterval(this._render,config.RENDER_INTERVAL)}_dispatchClick(e){const t=new MouseEvent(Mirror.eventNames.click,{view:window,screenX:e.screenX,screenY:e.screenY,clientX:e.clientX,clientY:e.clientY,button:e.button,buttons:e.buttons,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,bubbles:!0,cancelable:!0});this.getCloneElement().dispatchEvent(t)}_dispatchInput(){const e=new Event(Mirror.eventNames.input,{bubbles:!0,cancelable:!0});this.getCloneElement().dispatchEvent(e)}_getTargetElement(){return this._isRoamResearchIssue||this._isHootsuiteIssue||this._isDotSyntaxHighlighterIssue?this._mimickedElement.parentNode:this._mimickedElement}_render(){if(!this._mimickedElement.parentElement)return;this._domMeasurement.clearCache();const e=this._domMeasurement.getContentBox(this._mimickedElement,!1,!1);if(!this._container){if(this._container=createContainerElement(document,Mirror.CONTAINER_ELEMENT_NAME),this._container.style.display="none",this._wrapper=document.createElement("lt-div"),this._wrapper.setAttribute("spellcheck","true"),this._wrapper.className="lt-mirror__wrapper notranslate",this._canvas=document.createElement("lt-div"),this._canvas.className="lt-mirror__canvas",this._wrapper.appendChild(this._canvas),this._container.appendChild(this._wrapper),BrowserDetector.isFirefox()){this._elementInlineLineHeight=this._domMeasurement.getInlineStyle(this._mimickedElement,"line-height"),this._elementComputedLineHeight=this._domMeasurement.getStyle(this._mimickedElement,"line-height"),this._domMeasurement.getStyle(this._mimickedElement,"transition-property").match(/all|line\-height/)||(this._firefoxHackEnabled=!0)}const e=this._domMeasurement.getStyle(this._mimickedElement.parentElement,"display");"grid"!==e&&"inline-grid"!==e||this._container.classList.add("lt-mirror--grid-item")}this._firefoxHackEnabled&&(this._mimickedElement.style.lineHeight===this._elementComputedLineHeight?this._domMeasurement.setStyles(this._mimickedElement,{"line-height":this._elementInlineLineHeight}):this._elementInlineLineHeight=this._domMeasurement.getInlineStyle(this._mimickedElement,"lineHeight"),this._elementComputedLineHeight=this._domMeasurement.getStyle(this._mimickedElement,"line-height"),this._elementComputedLineHeight.includes("px")&&this._domMeasurement.setStyles(this._mimickedElement,{"line-height":this._elementComputedLineHeight}));const t=this._domMeasurement.getStyles(this._mimickedElement,["border","border-radius","border-top-width","border-right-width","border-left-width","border-bottom-width","border-top-style","border-right-style","border-left-style","border-bottom-style","direction","font","font-family","font-feature-settings","font-kerning","font-language-override","font-size","font-size-adjust","font-stretch","font-style","font-synthesis","font-variant","font-variant-caps","font-variant-east-asian","font-variant-ligatures","font-variant-numeric","font-weight","hyphens","letter-spacing","line-break","margin","margin-top","margin-left","margin-bottom","margin-right","padding","padding-top","padding-left","padding-right","padding-bottom","text-align","text-decoration","text-indent","text-rendering","text-transform","transform","transform-origin","unicode-bidi","white-space","word-spacing","word-wrap","writing-mode","zoom","-webkit-locale","-webkit-rtl-ordering"]);t["font-size"]=this._getWrapperFontSizeValue(t["font-size"]),t["line-height"]=this._domMeasurement.getExactStyle(this._mimickedElement,"line-height"),t["white-space"]=this._getWrapperWhiteSpaceValue(t["white-space"]),isSameObjects(t,this._wrapperStyles)||(this._domMeasurement.resetStyles(this._wrapper,t,!0),this._wrapperStyles=t),this._updateText();const i=this._getTargetElement();i.previousElementSibling!==this._container&&i.parentElement&&i.parentElement.insertBefore(this._container,i),this._domMeasurement.setStyles(this._wrapper,{width:e.width+"px",height:e.height+"px"},!0);const n=this._domMeasurement.getContentBox(this._wrapper,!1),r=e.left-n.left;if(Math.abs(r)>.05){let e=parseFloat(this._domMeasurement.getStyle(this._wrapper,"margin-left"));e+=r,this._domMeasurement.setStyles(this._wrapper,{"margin-left":e+"px"},!0)}const s=e.top-n.top;if(Math.abs(s)>.05){let e=parseFloat(this._domMeasurement.getStyle(this._wrapper,"margin-top"));e+=s,this._domMeasurement.setStyles(this._wrapper,{"margin-top":e+"px"},!0)}const a=this._domMeasurement.getScrollDimensions(this._mimickedElement,!1);let m=a.width-e.padding.left-e.padding.right,o=a.height-e.padding.top-e.padding.bottom;m===Math.round(e.width)&&(m=e.width),this._domMeasurement.setStyles(this._canvas,{width:m+"px",height:o+"px"},!0),this._updateScrolling(!1)}_getTextZoom(e=!1){if(e&&this._domMeasurement.clearCache(),!this._container)return 1;if(!BrowserDetector.isFirefox())return 1;return this._measurer||(this._measurer=document.createElement("lt-div"),this._measurer.className="lt-mirror__measurer",this._container.appendChild(this._measurer)),(Number.parseInt(this._domMeasurement.getStyle(this._measurer,"font-size"))||0)/100}_getWrapperFontSizeValue(e){const t=this._getTextZoom();return 1===t?e:(Number.parseFloat(e)||0)/t+"px"}_getWrapperWhiteSpaceValue(e){if(BrowserDetector.isChromium()){if("normal"===e)return"pre-wrap";if("nowrap"===e)return"pre"}return e}_updateScrolling(e=!0){e&&this._domMeasurement.clearCache();const t=this._domMeasurement.getScrollPosition(this._mimickedElement,!1),i=this._domMeasurement.getScrollPosition(this._mimickedElement,!0,!1),n=this._domMeasurement.getScrollPosition(this._mimickedElement);this._domMeasurement.setStyles(this._canvas,{"margin-top":-t.top+"px","margin-left":-t.left+"px"},!0),this._wrapper.dataset.ltScrollTop=t.top.toString(),this._wrapper.dataset.ltScrollLeft=t.left.toString(),this._wrapper.dataset.ltScrollTopScaled=i.top.toString(),this._wrapper.dataset.ltScrollLeftScaled=i.left.toString(),this._wrapper.dataset.ltScrollTopScaledAndZoomed=n.top.toString(),this._wrapper.dataset.ltScrollLeftScaledAndZoomed=n.left.toString()}_updateText(){const e=this._mimickedElement.value;this._currentText!==e&&(this._currentText=e,this._canvas.textContent=e,this._updateScrolling(),this._dispatchInput())}_onMimickedElementScroll(){window.requestAnimationFrame(()=>{this._updateScrolling()})}_onMimickedElementClick(e){void 0!==e.clientX&&void 0!==e.clientY&&this._dispatchClick(e)}getCloneElement(){return this._wrapper}enableRangeMeasurements(){this._wrapper.classList.add("lt-mirror-enable-range-measurement")}disableRangeMeasurements(){this._wrapper.classList.remove("lt-mirror-enable-range-measurement")}destroy(){this._mimickedElement.removeEventListener("input",this._updateText),this._mimickedElement.removeEventListener("scroll",this._onMimickedElementScroll),this._mimickedElement.removeEventListener("click",this._onMimickedElementClick),this._renderInterval&&this._renderInterval.destroy(),this._container&&this._container.remove(),this._mimickedElementResizeObserver&&this._mimickedElementResizeObserver.disconnect(),this._domMeasurement.clearCache()}}Mirror.CONTAINER_ELEMENT_NAME="lt-mirror",Mirror.eventNames={input:"lt-mirror.input",click:"lt-mirror.click"};